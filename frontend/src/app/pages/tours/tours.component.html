<!-- HERO -->
<section class="hero">
    <h1>Explora los Mejores Tours en Xalapa</h1>
    <p>Experiencias culturales, naturales y de aventura.</p>
</section>

<!-- FILTROS -->
<div class="filtros">
    <button *ngFor="let t of tipos" (click)="filtrar(t)" [class.activo]="t === tipoActual">
        {{ t | titlecase }}
    </button>
</div>

<!-- LISTA DE TOURS -->
<div class="lista-tours">

    <div class="tour-card fade-in" *ngFor="let tour of filtrados">

        <div class="thumb">
            <img class="tour-img" [src]="tour.imagen" alt="{{tour.nombre}}">
            <div class="badge">{{ tour.tipo | titlecase }}</div>
        </div>

        <div class="tour-info">
            <h2>{{ tour.nombre }}</h2>

            <p class="descripcion">
                {{ tour.descripcionBreve }}
            </p>

            <div class="meta">
                <span>‚è± {{ tour.duracion }}</span>
                <span *ngIf="tour.rating">‚òÖ {{ tour.rating }} ¬∑ {{ tour.reviews }} rese√±as</span>
            </div>

            <div class="card-bottom">
                <div class="price-block">
                    <div *ngIf="tour.precioAntes" class="old">${{ tour.precioAntes }} MXN</div>
                    <div class="price">Desde <strong>${{ tour.precio }} MXN</strong></div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="ver-btn" (click)="verDetalles(tour)">Ver m√°s</button>
                    <button (click)="toggleFavorito(tour.id)" class="btn-favorito" [ngClass]="{'favorito': isFavorito(tour.id)}" style="padding: 8px 12px; font-size: 16px; border: none; cursor: pointer; border-radius: 4px; background: #f0f0f0;">
                        {{ isFavorito(tour.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                    </button>
                </div>
            </div>

        </div>

    </div>

</div>
<!-- MODAL DETALLES -->
<div class="modal-overlay" *ngIf="tourSeleccionado" (click)="cerrarModal()">

    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" (click)="$event.stopPropagation()">

        <!-- CERRAR -->
        <button class="cerrar" (click)="cerrarModal()" aria-label="Cerrar">‚úñ</button>

        <!-- CONTENEDOR 2 COLUMNAS -->
        <div class="modal-grid">

            <!-- IZQUIERDA - GALER√çA -->
            <div class="modal-left">

                <h2 id="modal-title">{{ tourSeleccionado.nombre }}</h2>

                <!-- Imagen grande -->
                <div class="galeria-principal">
                    <img [src]="imagenActual || tourSeleccionado.galeria[0]" alt="Imagen principal del tour">
                </div>

                <!-- Miniaturas -->
                <div class="galeria-thumbs">
                    <img *ngFor="let img of tourSeleccionado.galeria" [src]="img" (click)="cambiarImagen(img)" [class.activa]="img === imagenActual" alt="Miniatura del tour">
                </div>

                <!-- Descripci√≥n -->
                <div class="descripcion-larga">
                    <p>{{ tourSeleccionado.descripcionLarga }}</p>
                </div>

                <!-- MAPA -->
                <div class="mapa" *ngIf="tourSeleccionado.mapa">
                    <iframe width="100%" height="300" [attr.src]="tourSeleccionado.mapa" style="border:0;" loading="lazy">
                    </iframe>
                </div>

            </div>

            <!-- DERECHA - PANEL DE RESERVA -->
            <div class="modal-right">

                <div class="precio-box">
                    <h3>Desde <span>${{ tourSeleccionado.precio }} MXN</span></h3>
                </div>

                <div class="inputs" *ngIf="!showDisponibilidad">
                    <label>Cantidad</label>
                    <select [(ngModel)]="cantidadSeleccionada">
                        <option *ngFor="let n of [1,2,3,4,5]" [value]="n"> {{n}} persona(s) </option>
                    </select>

                    <label>Fecha</label>
                    <input type="date" [(ngModel)]="fechaSeleccionada">
                </div>

                <button class="btn-reservar" *ngIf="!showDisponibilidad" (click)="reservar()">Ver disponibilidad</button>

                <!-- Panel de disponibilidad / formulario dentro del modal -->
                <div *ngIf="showDisponibilidad" class="disponibilidad-panel">
                    <div class="card">
                        <h4>Disponibilidad y detalles</h4>
                        <p><strong>Fecha seleccionada:</strong> {{ fechaSeleccionada || '‚Äî' }}</p>
                        <p><strong>Personas:</strong> {{ cantidadSeleccionada }}</p>
                        <p><strong>Total:</strong> ${{ (tourSeleccionado.precio || 0) * cantidadSeleccionada }} MXN</p>
                    </div>

                    <div class="card" style="margin-top:10px;">
                        <h4>Datos del cliente</h4>
                        <label>Nombre</label>
                        <input type="text" [(ngModel)]="clienteNombre" placeholder="Nombre" />
                        <label>Apellidos</label>
                        <input type="text" [(ngModel)]="clienteApellido" placeholder="Apellidos" />
                        <label>Tel√©fono</label>
                        <input type="text" [(ngModel)]="clienteTelefono" placeholder="Tel√©fono" />
                        <label>Correo</label>
                        <input type="email" [(ngModel)]="clienteEmail" placeholder="Correo electr√≥nico" />

                        <div style="margin-top:10px; display:flex; gap:8px;">
                            <button class="btn-primary" (click)="confirmarReserva()">Confirmar reserva</button>
                            <button class="btn-secondary" (click)="cancelarDisponibilidad()">Cancelar</button>
                            <button class="btn-secondary" (click)="abrirPaginaReserva()">Abrir en p√°gina de reserva</button>
                        </div>
                    </div>
                </div>

                <!-- COMENTARIOS Y CALIFICACIONES -->
                <h4 style="margin-top: 20px; margin-bottom: 10px;">Comentarios ({{ resenas.length }})</h4>

                <div class="resenas-list" *ngIf="resenas.length > 0; else noResenas">
                    <div class="resena-item" *ngFor="let r of resenas" style="border: 1px solid #ddd; padding: 10px; margin: 8px 0; border-radius: 4px; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>{{ r.usuario_nombre }}</strong>
                            <span style="color: #ff9800;">‚òÖ {{ r.calificacion }}</span>
                        </div>
                        <p style="font-size: 11px; color: #999; margin: 4px 0;">{{ r.created_at | date: 'short' }}</p>
                        <p style="font-weight: bold; margin: 4px 0;">{{ r.titulo }}</p>
                        <p style="margin: 4px 0;">{{ r.texto }}</p>
                    </div>
                </div>
                <ng-template #noResenas>
                    <p style="color: #999; font-size: 13px;">No hay comentarios a√∫n.</p>
                </ng-template>

                <!-- Formulario para agregar comentario -->
                <div *ngIf="isLoggedIn" style="margin-top: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                    <button *ngIf="!showResenaForm" (click)="showResenaForm = true" style="background: #2196F3; color: white; padding: 6px 12px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Agregar comentario</button>

                    <div *ngIf="showResenaForm">
                        <div style="margin-bottom: 6px;">
                            <label style="font-size: 12px;">‚òÖ Calificaci√≥n:</label>
                            <select [(ngModel)]="resenaForm.calificacion" style="width: 100%; padding: 4px; font-size: 12px;">
                                <option [value]="1">1 - Muy malo</option>
                                <option [value]="2">2 - Malo</option>
                                <option [value]="3">3 - Regular</option>
                                <option [value]="4">4 - Bueno</option>
                                <option [value]="5">5 - Excelente</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 6px;">
                            <input type="text" [(ngModel)]="resenaForm.titulo" placeholder="T√≠tulo..." style="width: 100%; padding: 4px; font-size: 12px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 6px;">
                            <textarea [(ngModel)]="resenaForm.texto" placeholder="Tu comentario..." rows="3" style="width: 100%; padding: 4px; font-size: 12px; box-sizing: border-box;"></textarea>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button (click)="addResena()" style="background: #4CAF50; color: white; padding: 6px 12px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Enviar</button>
                            <button (click)="showResenaForm = false" style="background: #ddd; color: #333; padding: 6px 12px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Cancelar</button>
                        </div>
                    </div>
                </div>

                <div class="beneficios">
                    <p>‚úî Cancelaci√≥n gratuita</p>
                    <p>‚úî Reservar ahora y pagar despu√©s</p>
                </div>

            </div>

        </div>

    </div>
</div>