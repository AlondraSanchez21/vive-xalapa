<div class="hoteles-wrap">
    <h2>Reservaci√≥n de Hoteles</h2>

    <div class="search-row">
        <div class="input-group">
            <label>¬øA d√≥nde quieres ir?</label>
            <input type="text" [(ngModel)]="destinationInput" (focus)="openMunicipiosIfXalapa()" placeholder="Ciudad, zona..." />
            <small class="hint">Si escribes "Xalapa" se abrir√° una lista de zonas/municipios</small>
        </div>

        <div class="input-group">
            <label>Seleccionar hotel</label>
            <select [(ngModel)]="selectedHotelId" name="selTopHotel">
                            <option *ngFor="let h of hotels" [value]="h.id">{{ h.name }} ‚Äî {{ h.location }} ¬∑ ${{ h.priceMXN }}</option>
                        </select>
        </div>
        <div class="input-group" *ngIf="isLoggedIn; else noPromo">
            <label>Promoci√≥n</label>
            <select [(ngModel)]="currentPromo.key" (ngModelChange)="setPromo($event)" name="promoSelect">
                <option *ngFor="let p of promos" [value]="p.key">{{ p.label }} {{ p.percent ? (' - ' + p.percent + '%') : '' }}</option>
            </select>
            <small class="hint">Selecciona una promoci√≥n para probar descuentos</small>
        </div>
        <ng-template #noPromo>
            <div class="input-group">
                <label>Promoci√≥n</label>
                <div class="hint">Inicia sesi√≥n para ver promociones</div>
            </div>
        </ng-template>
    </div>

    <!-- LISTADO DE HOTELS (tarjetas) -->
    <section class="hotel-list">
        <div class="hotel-card" *ngFor="let h of hotels">
            <div class="hotel-image" (click)="openHotelModal(h.id)">
                <!-- si tienes im√°genes reales, √∫salas; aqu√≠ fallback -->
                <img [src]="h.images && h.images.length ? h.images[0] : '/assets/hotel-placeholder.png'" alt="{{ h.name }}">
            </div>
            <div class="hotel-meta">
                <h4>{{ h.name }}</h4>
                <p class="loc">{{ h.location }}</p>
                <p class="price">
                    <ng-container *ngIf="getPriceWithDiscount(h) as p">
                        <span class="final">$ {{ p.finalPrice }} MXN</span>
                        <small class="orig">$ {{ p.original }} MXN</small>
                        <span *ngIf="p.discountPercent > 0" class="discount">-{{ p.discountPercent }}%</span>
                        <div class="price-note" *ngIf="p.discountPercent > 0">Descuento por usuario registrado</div>
                    </ng-container>
                </p>
                <div class="card-actions">
                    <button (click)="openHotelModal(h.id)" class="btn-primary">Ver detalles</button>
                    <button (click)="selectedHotelId = h.id; showReservaModal = true" class="btn-secondary">Reservar</button>
                    <button (click)="toggleFavorito(h.id)" class="btn-favorito" [ngClass]="{'favorito': isFavorito(h.id)}">
                        {{ isFavorito(h.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Formulario (modal) - reutilizable -->
    <div class="modal-backdrop" *ngIf="showReservaModal" (click)="closeReservaModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h4>Formulario de reservaci√≥n</h4>
                <button class="close" (click)="closeReservaModal()">‚úï</button>
            </div>

            <form (ngSubmit)="reservar()" class="reserva-form">
                <div class="grid">
                    <div class="field">
                        <label>Hotel</label>
                        <select [(ngModel)]="selectedHotelId" name="selHotel">
              <option *ngFor="let h of hotels" [value]="h.id">{{ h.name }}</option>
            </select>
                    </div>

                    <div class="field">
                        <label>Check-in</label>
                        <input type="date" [(ngModel)]="checkIn" name="checkIn" required />
                    </div>
                    <div class="field">
                        <label>Check-out</label>
                        <input type="date" [(ngModel)]="checkOut" name="checkOut" required />
                    </div>
                    <div class="field">
                        <label>Hu√©spedes</label>
                        <input type="number" min="1" [(ngModel)]="guests" name="guests" />
                    </div>
                    <div class="field">
                        <label>Habitaciones</label>
                        <input type="number" min="1" [(ngModel)]="rooms" name="rooms" />
                    </div>
                    <div class="field full">
                        <label>Tipo de habitaci√≥n</label>
                        <select [(ngModel)]="roomType" name="roomType">
              <option>Est√°ndar</option>
              <option>Suite</option>
              <option>Familiar</option>
            </select>
                    </div>

                    <div class="field full">
                        <label>Nombre completo</label>
                        <input type="text" [(ngModel)]="clientName" name="clientName" required />
                    </div>
                    <div class="field">
                        <label>Correo</label>
                        <input type="email" [(ngModel)]="clientEmail" name="clientEmail" required />
                    </div>
                    <div class="field">
                        <label>Tel√©fono</label>
                        <input type="text" [(ngModel)]="clientPhone" name="clientPhone" />
                    </div>

                    <div class="field full">
                        <label>Peticiones especiales</label>
                        <textarea rows="3" [(ngModel)]="requests" name="requests"></textarea>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="btn-primary">Reservar ahora</button>
                    <button type="button" class="btn-secondary" (click)="resetForm()">Limpiar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de reservas guardadas (demo) -->
    <section class="my-reservas" *ngIf="reservations.length > 0">
        <h3>Mis reservas</h3>
        <div class="res-item" *ngFor="let r of reservations; let i = index">
            <div>
                <strong>{{ r.hotelName }}</strong> ‚Äî {{ r.location }}<br /> {{ r.checkIn }} ‚Üí {{ r.checkOut }} ¬∑ {{ r.guests }} hu√©sp. ¬∑ {{ r.rooms }} hab.
            </div>
            <div class="res-actions">
                <button (click)="removeReservation(i)">Eliminar</button>
            </div>
        </div>
    </section>
</div>

<!-- Modal municipios -->
<div class="modal-backdrop" *ngIf="showMunicipiosModal" (click)="closeMunicipiosModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h4>Elige una zona / municipio en Xalapa</h4>
            <button class="close" (click)="closeMunicipiosModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <ul class="municipios-list">
                <li *ngFor="let m of municipiosXalapa">
                    <button (click)="selectMunicipio(m)">{{ m }}</button>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Modal detalle de hotel -->
<div class="modal-backdrop" *ngIf="showHotelModal" (click)="closeHotelModal()">
    <div class="modal hotel-detail" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>{{ activeHotel?.name }}</h3>
            <button class="close" (click)="closeHotelModal()">‚úï</button>
        </div>

        <div class="hotel-detail-body">
            <div class="left">
                <div class="image-frame">
                    <button class="img-nav left" (click)="prevImage()">‚Äπ</button>
                    <img [src]="activeHotel?.images && activeHotel.images.length ? activeHotel.images[activeImageIndex] || '/assets/hotel-placeholder.png' : '/assets/hotel-placeholder.png'" alt="{{ activeHotel?.name }}">
                    <button class="img-nav right" (click)="nextImage()">‚Ä∫</button>
                </div>

                <!-- mapa centrado (ejemplo con iframe embed) -->
                <div class="map-container">
                    <iframe [src]="'https://www.google.com/maps?q=' + (activeHotel?.location || 'Xalapa') + '&output=embed'" width="100%" height="260" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                </div>
            </div>

            <div class="right">
                <p class="loc">{{ activeHotel?.location }}</p>
                <p class="desc">{{ activeHotel?.description }}</p>

                <h4>Tipos de habitaci√≥n</h4>
                <div class="room-list">
                    <div class="room-card" *ngFor="let room of activeHotel?.rooms">
                        <div>
                            <strong>{{ room.name }}</strong>
                            <div class="beds">{{ room.beds }}</div>
                        </div>
                        <div>
                            <div class="price">
                                <ng-container *ngIf="activeHotel">
                                    <span class="final">$ {{ (room.priceMXN * (1 - (isLoggedIn ? 0.1 : 0))) | number:'1.0-0' }} MXN</span>
                                    <small class="orig">$ {{ room.priceMXN }} MXN</small>
                                </ng-container>
                            </div>
                            <button class="btn-primary" (click)="openReservaFromHotel()">Reservar</button>
                        </div>
                    </div>
                </div>

                <!-- COMENTARIOS Y CALIFICACIONES -->
                <h4 style="margin-top: 20px;">Comentarios y Calificaciones</h4>

                <!-- Mostrar comentarios existentes -->
                <div class="resenas-list" *ngIf="resenas.length > 0; else noResenas">
                    <div class="resena-item" *ngFor="let r of resenas" style="border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>{{ r.usuario_nombre }}</strong>
                            <span style="color: #ff9800;">‚òÖ {{ r.calificacion }}</span>
                        </div>
                        <p style="font-size: 12px; color: #666; margin: 4px 0;">{{ r.created_at | date: 'short' }}</p>
                        <p><strong>{{ r.titulo }}</strong></p>
                        <p>{{ r.texto }}</p>
                    </div>
                </div>
                <ng-template #noResenas>
                    <p style="color: #999;">No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>
                </ng-template>

                <!-- Formulario para agregar comentario (solo usuarios logueados) -->
                <div *ngIf="isLoggedIn" style="margin-top: 16px; background: #f9f9f9; padding: 12px; border-radius: 4px;">
                    <button *ngIf="!showResenaForm" (click)="showResenaForm = true" style="background: #2196F3; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Agregar comentario</button>

                    <div *ngIf="showResenaForm">
                        <div style="margin-bottom: 8px;">
                            <label>Calificaci√≥n:</label>
                            <select [(ngModel)]="resenaForm.calificacion" style="width: 100%; padding: 6px;">
                                <option [value]="1">1 - Muy malo</option>
                                <option [value]="2">2 - Malo</option>
                                <option [value]="3">3 - Regular</option>
                                <option [value]="4">4 - Bueno</option>
                                <option [value]="5">5 - Excelente</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <label>T√≠tulo:</label>
                            <input type="text" [(ngModel)]="resenaForm.titulo" placeholder="Ej: Excelente ubicaci√≥n" style="width: 100%; padding: 6px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 8px;">
                            <label>Comentario:</label>
                            <textarea [(ngModel)]="resenaForm.texto" placeholder="Cu√©ntanos tu experiencia..." rows="4" style="width: 100%; padding: 6px; box-sizing: border-box;"></textarea>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button (click)="addResena()" style="background: #4CAF50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Enviar</button>
                            <button (click)="showResenaForm = false" style="background: #ccc; color: #333; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
                        </div>
                    </div>
                </div>

                <div class="detail-actions">
                    <button class="btn-secondary" (click)="closeHotelModal()">Volver</button>
                    <button class="btn-primary" (click)="openReservaFromHotel()">Reservar habitaci√≥n</button>
                </div>
            </div>
        </div>
    </div>
</div>